<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyVitals Sign Up Page</title>
    <link rel="stylesheet" href="signupform.css">
    <link rel="icon" type="image/x-icon" href="Doctor_icon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body>
    <div class="center">
        <div class="content">
            <div class="video-box">
                <video width="300" height="300" autoplay loop muted>
                    <source src="PyVitals.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>

            <div class="info-box">
                <h5 class="paragraph">Tell us about yourself</h5>
            
                <form class="needs-validation" novalidate id="signupForm">
                    <div class="row mb-3">
                        <div class="col">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" id="firstName" class="form-control" placeholder="Enter first name" required
                                pattern="[A-Za-z\s]{2,50}">
                            <div class="invalid-feedback">Please enter a valid first name (2-50 letters).</div>
                        </div>
                        <div class="col">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" id="lastName" class="form-control" placeholder="Enter last name" required
                                pattern="[A-Za-z\s]{2,50}">
                            <div class="invalid-feedback">Please enter a valid last name (2-50 letters).</div>
                        </div>
                    </div>
            
                    <div class="mb-3">
                        <label class="form-label space">Gender</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender" id="male" value="Male" required>
                            <label class="form-check-label" for="male">Male</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender" id="female" value="Female" required>
                            <label class="form-check-label" for="female">Female</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender" id="other" value="Other" required>
                            <label class="form-check-label" for="other">Other</label>
                        </div>
                        <div class="invalid-feedback">Please select your gender.</div>
                    </div>
            
                    <div class="mb-3">
                        <label for="email" class="form-label">Email address</label>
                        <input type="email" id="email" class="form-control" placeholder="Enter email" required>
                        <div class="invalid-feedback">Valid email is required.</div>
                        <div id="emailFeedback" class="form-text text-danger" style="display: none;">Invalid email
                            format.</div>
                    </div>
            
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="password" class="form-control" placeholder="Enter password" required
                                minlength="8">
                            <button class="btn toggle-password" type="button" data-target="password">
                                <i class="bi bi-eye eyesbutton"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">Password must be at least 8 characters.</div>
                        <div id="passwordStrength" class="form-text"></div>
                    </div>
            
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <div class="input-group">
                            <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm password" required
                                minlength="8">
                            <button class="btn toggle-password" type="button" data-target="confirmPassword">
                                <i class="bi bi-eye eyesbutton"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">Please confirm your password.</div>
                        <div id="confirmPasswordFeedback" class="form-text text-danger" style="display: none;">Passwords
                            do not match.</div>
                    </div>
            
                    <div class="mb-4">
                        <label for="dob" class="form-label">Date of Birth</label>
                        <input type="date" id="dob" class="form-control" required max="2010-12-31">
                        <div class="invalid-feedback">You must be at least 13 years old.</div>
                    </div>
            
                    <input type="hidden" id="role" name="role">
            
                    <button type="submit" class="btn btn-primary w-100" id="submitBtn">Create Account</button>
                    <div id="loadingSpinner" class="spinner-border text-primary mt-3 mx-auto" role="status" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </form>
            
                <div id="alertContainer" class="mt-3"></div>
            </div>
            </div>
            </div>
            
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    // Elements
                    const form = document.getElementById('signupForm');
                    const firstNameInput = document.getElementById('firstName');
                    const lastNameInput = document.getElementById('lastName');
                    const genderInputs = document.querySelectorAll('input[name="gender"]');
                    const emailInput = document.getElementById('email');
                    const emailFeedback = document.getElementById('emailFeedback');
                    const passwordInput = document.getElementById('password');
                    const passwordStrength = document.getElementById('passwordStrength');
                    const confirmPasswordInput = document.getElementById('confirmPassword');
                    const confirmPasswordFeedback = document.getElementById('confirmPasswordFeedback');
                    const dobInput = document.getElementById('dob');
                    const roleInput = document.getElementById('role');
                    const submitBtn = document.getElementById('submitBtn');
                    const loadingSpinner = document.getElementById('loadingSpinner');
                    const alertContainer = document.getElementById('alertContainer');

                    // Set max date for DOB (13 years ago)
                    const today = new Date();
                    const maxDob = new Date(today.getFullYear() - 13, today.getMonth(), today.getDate());
                    dobInput.max = maxDob.toISOString().split('T')[0];

                    // Load role from localStorage
                    const savedRole = localStorage.getItem("userRole");
                    if (savedRole) {
                        roleInput.value = savedRole;
                    } else {
                        showAlert('Please select a role before signing up.', 'danger');
                        // Redirect to role selection if no role is found
                        setTimeout(() => {
                            window.location.href = "index.html";
                        }, 2000);
                    }

                    // Toggle password visibility
                    document.querySelectorAll(".toggle-password").forEach(button => {
                        button.addEventListener("click", function () {
                            const input = document.getElementById(this.getAttribute("data-target"));
                            const icon = this.querySelector("i");
                            if (input.type === "password") {
                                input.type = "text";
                                icon.classList.replace("bi-eye", "bi-eye-slash");
                            } else {
                                input.type = "password";
                                icon.classList.replace("bi-eye-slash", "bi-eye");
                            }
                        });
                    });

                    // Name validation (only letters and spaces)
                    firstNameInput.addEventListener('input', function () {
                        this.value = this.value.replace(/[^A-Za-z\s]/g, '');
                    });

                    lastNameInput.addEventListener('input', function () {
                        this.value = this.value.replace(/[^A-Za-z\s]/g, '');
                    });

                    // Password strength meter
                    passwordInput.addEventListener('input', () => {
                        const strength = getPasswordStrength(passwordInput.value);
                        passwordStrength.textContent = strength.message;
                        passwordStrength.className = 'form-text ' + strength.className;
                    });

                    function getPasswordStrength(password) {
                        if (password.length === 0) return { message: '', className: '' };
                        if (password.length < 6) return { message: 'Password is too short.', className: 'text-danger' };
                        if (password.length < 10) return { message: 'Weak password.', className: 'text-warning' };
                        if (!/[A-Z]/.test(password)) return { message: 'Add uppercase letters.', className: 'text-warning' };
                        if (!/[0-9]/.test(password)) return { message: 'Add numbers.', className: 'text-warning' };
                        if (!/[\W_]/.test(password)) return { message: 'Add special characters.', className: 'text-warning' };
                        return { message: 'Strong password.', className: 'text-success' };
                    }

                    // Confirm password match live check
                    confirmPasswordInput.addEventListener('input', () => {
                        confirmPasswordFeedback.style.display = (confirmPasswordInput.value !== passwordInput.value) ? 'block' : 'none';
                    });

                    // Live email availability check with debounce
                    let emailCheckTimeout = null;
                    emailInput.addEventListener('input', () => {
                        clearTimeout(emailCheckTimeout);
                        const email = emailInput.value.trim();

                        // Basic email format check
                        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailPattern.test(email)) {
                            emailFeedback.style.display = 'block';
                            emailFeedback.textContent = "Invalid email format.";
                            return;
                        } else {
                            emailFeedback.style.display = 'none';
                        }

                        // Debounce API call
                        emailCheckTimeout = setTimeout(async () => {
                            try {
                                const response = await fetch('https://pyvitals.onrender.com/api/users/check-email', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ email }),
                                });

                                if (response.ok) {
                                    const result = await response.json();
                                    if (result.exists) {
                                        emailFeedback.style.display = 'block';
                                        emailFeedback.textContent = "Email is already registered.";
                                    } else {
                                        emailFeedback.style.display = 'none';
                                    }
                                }
                            } catch (error) {
                                console.error("Email check error:", error);
                                // Silently fail - email check is not critical
                            }
                        }, 800);
                    });

                    // Form submission handler
                    form.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        event.stopPropagation();

                        // Validate role presence
                        if (!roleInput.value) {
                            showAlert('Please select a role before signing up.', 'danger');
                            return;
                        }

                        // Validate form fields using HTML5 validation
                        if (!form.checkValidity()) {
                            form.classList.add('was-validated');
                            // Find first invalid field and focus on it
                            const invalidField = form.querySelector(':invalid');
                            if (invalidField) {
                                invalidField.focus();
                            }
                            return;
                        }

                        // Validate gender selected
                        const genderSelected = Array.from(genderInputs).some(input => input.checked);
                        if (!genderSelected) {
                            showAlert('Please select your gender.', 'danger');
                            return;
                        }

                        // Validate password match
                        if (passwordInput.value !== confirmPasswordInput.value) {
                            showAlert('Passwords do not match.', 'danger');
                            confirmPasswordInput.focus();
                            return;
                        }

                        // Validate email availability (if emailFeedback visible with error, block submit)
                        if (emailFeedback.style.display === 'block' && emailFeedback.textContent.includes('registered')) {
                            showAlert('Email is already registered.', 'danger');
                            emailInput.focus();
                            return;
                        }

                        // All validations passed, prepare data
                        const userData = {
                            firstName: firstNameInput.value.trim(),
                            lastName: lastNameInput.value.trim(),
                            gender: document.querySelector('input[name="gender"]:checked').value,
                            email: emailInput.value.trim().toLowerCase(),
                            password: passwordInput.value,
                            dob: dobInput.value,
                            role: roleInput.value,
                        };

                        console.log("Sending user data:", userData);

                        try {
                            showLoadingSpinner();
                            const response = await fetch('https://pyvitals.onrender.com/api/users/register', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(userData),
                            });

                            let result;
                            try {
                                result = await response.json();
                            } catch (e) {
                                console.error("Failed to parse JSON:", e);
                                showAlert("Server returned invalid response. Please try again.", 'danger');
                                hideLoadingSpinner();
                                return;
                            }

                            if (response.ok) {
                                showAlert(result.message || "Account created successfully!", 'success');
                                // Store user email for face authentication page
                                localStorage.setItem('userEmail', userData.email);

                                setTimeout(() => {
                                    window.location.href = "faceauthentication.html";
                                }, 1500);
                            } else {
                                const errorMsg = result.error || result.message || "Something went wrong. Please try again.";
                                showAlert(errorMsg, 'danger');
                            }
                        } catch (err) {
                            console.error("❌ Register error:", err);
                            showAlert("Network error. Please check your connection and try again.", "danger");
                        } finally {
                            hideLoadingSpinner();
                        }
                    });

                    // Helper functions
                    function showAlert(message, type) {
                        alertContainer.innerHTML = `
                                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>`;
                    }

                    function showLoadingSpinner() {
                        loadingSpinner.style.display = 'block';
                        submitBtn.disabled = true;
                        submitBtn.textContent = "Processing...";
                    }

                    function hideLoadingSpinner() {
                        loadingSpinner.style.display = 'none';
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Create Account";
                    }
                });
            </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
</body>

</html>
